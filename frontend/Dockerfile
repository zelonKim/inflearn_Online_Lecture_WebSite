FROM node:20-alpine

RUN npm install -g pnpm

ARG NODE_ENV
ARG API_URL
ARG AUTH_SECRET
ARG CLOUDFRONT_DOMAIN
ARG NEXT_PUBLIC_PORTONE_STORE_ID
ARG NEXT_PUBLIC_PORTONE_CHANNEL_KEY
ARG DATABASE_URL
ARG NEXTAUTH_URL

ENV NODE_ENV=$NODE_ENV
ENV API_URL=$API_URL
ENV AUTH_SECRET=$AUTH_SECRET
ENV CLOUDFRONT_DOMAIN=$CLOUDFRONT_DOMAIN
ENV NEXT_PUBLIC_PORTONE_STORE_ID=$NEXT_PUBLIC_PORTONE_STORE_ID
ENV NEXT_PUBLIC_PORTONE_CHANNEL_KEY=$NEXT_PUBLIC_PORTONE_CHANNEL_KEY
ENV DATABASE_URL=$DATABASE_URL
ENV NEXTAUTH_URL=$NEXTAUTH_URL

WORKDIR /app

COPY package.json pnpm-lock.yaml ./

RUN pnpm install

COPY . .

ENV NODE_ENV=production

RUN pnpm prisma generate

RUN pnpm run build

EXPOSE 3000

CMD ["pnpm", "run", "start"]